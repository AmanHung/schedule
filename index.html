<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>線上排班系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // ==========================================
        // CONFIGURATION 設定區
        // ==========================================
        const USE_MOCK_DATA = false; 
        const GOOGLE_SPREADSHEET_ID = "1OfGyESqORhCNdQRm7kVQkF9jirkpZPO1FNnZxmzFIZc"; 
        const SHIFT_DEF_SHEET_NAME = "班別資料"; 

        // ==========================================
        // MOCK DATA 模擬資料
        // ==========================================
        const MOCK_SHIFT_DEFS = `班別,時數,時間,說明
-,0,-:~-:,未排班
A,8,15:45~00:15,"小夜班ER ,休息(15:45-16:00,0:00-0:15)"
D,8,08:00~17:30,"正常班(0800~1200,1330~1730)"
D6,8,08:30~17:00,"8:30-12:30,13:00-17:00"
O,0,-:~-:,休假
H,0,-:~-:,例假日
TD,8,09:00~17:30,TD班
DP1,10,08:00~20:30,"夜診(0800~1200,1330~1730,1830~2030)"
RD,8,08:00~16:00,RD班
U,0,-:~-:,特休
S,4,08:00~12:00,半天班
D0,8,08:00~17:00,特殊D0`;

        const MOCK_SCHEDULE_2026_01 = `職稱,員工編號,姓名,1(四),2(五),3(六),4(日),5(一),6(二),7(三),8(四),9(五),10(六),11(日),12(一),13(二),14(三),15(四),16(五),17(六),18(日),19(一),20(二),21(三),22(四),23(五),24(六),25(日),26(一),27(二),28(三),29(四),30(五),31(六)
排班負責人,2277,洪一仁,-,D,-,-,D,D,D,D,D,-,-,D,D,D,D,D,-,-,D,D,D,D,D,-,-,D,D,D,D,D,-
一般同仁,116,吳惠珠,D,D6,C,-,D6,S1,D6,DP1,-,-,-,D6,S1,D6,D6,D6,-,-,D6,D6,D6,DP1,D6,-,-,D6,S1,D6,D6,D6,C
一般同仁,2772,陳佳瑜,D,-,-,-,D,DP1,D,D,D,-,-,D,D,D,D,DP1,-,-,D,S2,D,D,S,-,-,D,D,D,D,S,HD
一般同仁,4602,林聖雅,D8,TD,O,H,D8,D4,D4,O,TD,U,H,D6,D4,A,O,O,O,H,D4,TP1,RD,D4,D4,TS1,H,TD,SP,O,DP2,D4,U
一般同仁,5035,陳妍蓁,D1,D2,O,H,D4,D3,D7,DP2,D1,O,H,D9,D5,SP,O,NN,U,H,D7,O,D6,O,TP1,C,H,ED,D4,TD,D4,SP,O
一般同仁,5052,解志欽,NN,NN,O,H,O,NN,NN,NN,NN,O,H,D,D,D,D,D,O,H,NN,NN,NN,NN,NN,O,H,NN,NN,NN,NN,D0,O
一般同仁,5233,陳凱微,D5,D3,O,H,D5,TS1,D1,RD,DP2,O,H,SP,SP,O,ED,D8,O,H,D5,D7,D4,TP1,TD,U,H,RD,D6,A,O,D2,O`;

        // ==========================================
        // HELPER FUNCTIONS 工具函式
        // ==========================================
        
        const generateMonthOptions = () => {
            const options = [];
            const today = new Date();
            const currentYear = today.getFullYear();
            const startYear = currentYear - 1;
            const endYear = currentYear + 1;

            for (let y = startYear; y <= endYear; y++) {
                for (let m = 1; m <= 12; m++) {
                    const monthStr = `${y}-${String(m).padStart(2, '0')}`;
                    options.push(monthStr);
                }
            }
            return options.reverse();
        };

        const parseCSV = (text) => {
            const rows = [];
            let currentRow = [];
            let currentCell = '';
            let inQuotes = false;

            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                const nextChar = text[i + 1];

                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        currentCell += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    currentRow.push(currentCell.trim());
                    currentCell = '';
                } else if ((char === '\r' || char === '\n') && !inQuotes) {
                    if (char === '\r' && nextChar === '\n') i++;
                    if (currentCell || currentRow.length > 0) {
                        currentRow.push(currentCell.trim());
                        rows.push(currentRow);
                    }
                    currentRow = [];
                    currentCell = '';
                } else {
                    currentCell += char;
                }
            }
            if (currentCell || currentRow.length > 0) {
                currentRow.push(currentCell.trim());
                rows.push(currentRow);
            }
            return rows;
        };

        const processShiftDefs = (csvText) => {
            const rows = parseCSV(csvText);
            const defs = {};
            const order = [];
            
            for(let i=1; i<rows.length; i++) {
                if (rows[i].length < 2) continue;
                const [code, hours, time, desc] = rows[i];
                if(code) {
                    const cleanCode = code.trim();
                    defs[cleanCode] = { hours, time, desc };
                    order.push(cleanCode);
                }
            }
            return { defs, order };
        };

        const processSchedule = (csvText) => {
            const rows = parseCSV(csvText);
            let headerRowIndex = rows.findIndex(row => row.includes("姓名"));
            if (headerRowIndex === -1) return { headers: [], data: [] };

            const headers = rows[headerRowIndex];
            const data = rows.slice(headerRowIndex + 1).filter(row => row.length > 3 && row[2]); 

            const dateHeaders = headers.slice(3).map(h => h);
            return { headers: dateHeaders, data, rawHeaders: headers };
        };

        // ==========================================
        // COMPONENT: SHIFT DETAILS MODAL (更新版：含換班功能)
        // ==========================================
        const ShiftDetailModal = ({ shiftInfo, onClose, scheduleData, currentMonth }) => {
            const [isSwapMode, setIsSwapMode] = useState(false);
            const [targetPerson, setTargetPerson] = useState(""); // 格式: "姓名,班別"

            if (!shiftInfo) return null;

            // 重置狀態
            useEffect(() => {
                setIsSwapMode(false);
                setTargetPerson("");
            }, [shiftInfo]);

            // 取得當天日期字串，例如: "1/13(二)"
            const getDateLabel = () => {
                if (shiftInfo.dayIndex === null || !scheduleData.headers) return "";
                const header = scheduleData.headers[shiftInfo.dayIndex]; // e.g., "13(二)"
                const month = parseInt(currentMonth.split('-')[1]);
                return `${month}/${header}`;
            };

            // 取得當天所有其他人的班表選項
            const getColleagueOptions = () => {
                if (shiftInfo.dayIndex === null || !scheduleData.data) return [];
                const idx = shiftInfo.dayIndex;
                
                return scheduleData.data
                    .filter(row => row[2] !== shiftInfo.personName) // 排除自己
                    .map(row => {
                        const pName = row[2];
                        const pShift = row[3 + idx]; // 該員當天的班別
                        if (!pShift || pShift === "-") return null; // 排除空班或無班別 (視需求可保留)
                        return { name: pName, shift: pShift };
                    })
                    .filter(item => item !== null); // 過濾掉 null
            };

            // 產生 Line 連結
            const handleLineShare = () => {
                if (!targetPerson) return alert("請先選擇交換對象");
                
                const [tName, tShift] = targetPerson.split(',');
                const dateStr = getDateLabel();
                
                // 需求格式：1/13(二)洪一仁(D)申請與郭益宏(D2)互換
                const msg = `${dateStr}${shiftInfo.personName}(${shiftInfo.code})申請與${tName}(${tShift})互換`;
                
                const encodedMsg = encodeURIComponent(msg);
                window.location.href = `https://line.me/R/msg/text/?${encodedMsg}`;
            };

            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm animate-fade-in" onClick={onClose}>
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden" onClick={e => e.stopPropagation()}>
                        {/* 標題區 */}
                        <div className="bg-blue-600 p-4 text-white flex justify-between items-center">
                            <h3 className="text-xl font-bold flex items-center gap-2">
                                <span className="bg-white text-blue-600 px-2 rounded text-sm font-black">{shiftInfo.code}</span>
                                {isSwapMode ? "換班申請" : "班別詳情"}
                            </h3>
                            <button onClick={onClose} className="hover:bg-blue-700 p-1 rounded transition">
                                <i data-lucide="x" className="w-5 h-5"></i>
                            </button>
                        </div>

                        {/* 內容區 */}
                        <div className="p-6 space-y-4">
                            {!isSwapMode ? (
                                <>
                                    {/* 既有詳情內容 */}
                                    <div>
                                        <label className="text-xs font-bold text-gray-400 uppercase tracking-wider block mb-1">工作時間</label>
                                        <div className="text-lg font-medium text-gray-800 bg-gray-50 p-3 rounded border border-gray-100">
                                            {shiftInfo.time || "無時間資料"}
                                        </div>
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-gray-400 uppercase tracking-wider block mb-1">說明</label>
                                        <div className="text-gray-600 whitespace-pre-wrap leading-relaxed">
                                            {shiftInfo.desc || "無說明內容"}
                                        </div>
                                    </div>
                                    
                                    {/* 只有當有「人」與「日期」資訊時，才顯示換班按鈕 */}
                                    {shiftInfo.personName && shiftInfo.dayIndex !== null && (
                                        <button 
                                            onClick={() => setIsSwapMode(true)}
                                            className="w-full mt-2 bg-green-50 text-green-700 border border-green-200 hover:bg-green-100 font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-2 transition"
                                        >
                                            <i data-lucide="arrow-left-right" className="w-5 h-5"></i>
                                            申請換班
                                        </button>
                                    )}
                                </>
                            ) : (
                                <>
                                    {/* 換班模式內容 */}
                                    <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                        <div className="text-sm text-gray-500 mb-1">申請人 (原班別)</div>
                                        <div className="font-bold text-gray-800 text-lg flex items-center gap-2">
                                            {shiftInfo.personName} 
                                            <span className="bg-blue-100 text-blue-800 px-2 py-0.5 rounded text-sm">{shiftInfo.code}</span>
                                        </div>
                                        <div className="text-xs text-gray-400 mt-1">{getDateLabel()}</div>
                                    </div>

                                    <div className="flex justify-center text-gray-300">
                                        <i data-lucide="arrow-down" className="w-6 h-6"></i>
                                    </div>

                                    <div>
                                        <label className="text-xs font-bold text-gray-400 uppercase tracking-wider block mb-1">選擇交換對象</label>
                                        <select 
                                            value={targetPerson}
                                            onChange={e => setTargetPerson(e.target.value)}
                                            className="w-full bg-white border border-gray-300 text-gray-900 text-lg rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5"
                                        >
                                            <option value="" disabled>請選擇同仁...</option>
                                            {getColleagueOptions().map((opt, idx) => (
                                                <option key={idx} value={`${opt.name},${opt.shift}`}>
                                                    {opt.name} ({opt.shift})
                                                </option>
                                            ))}
                                        </select>
                                    </div>

                                    <button 
                                        onClick={handleLineShare}
                                        disabled={!targetPerson}
                                        className={`w-full font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-2 transition shadow-sm ${
                                            targetPerson 
                                            ? 'bg-[#06C755] hover:bg-[#05b34c] text-white' 
                                            : 'bg-gray-200 text-gray-400 cursor-not-allowed'
                                        }`}
                                    >
                                        <i data-lucide="send" className="w-5 h-5"></i>
                                        Line 一鍵傳送
                                    </button>

                                    <button 
                                        onClick={() => setIsSwapMode(false)}
                                        className="w-full text-gray-400 text-sm hover:text-gray-600 py-2"
                                    >
                                        取消
                                    </button>
                                </>
                            )}
                        </div>
                        
                        {/* 底部關閉 (非換班模式才顯示，避免按鈕太多) */}
                        {!isSwapMode && (
                            <div className="bg-gray-50 p-4 border-t border-gray-100 text-center">
                                <button onClick={onClose} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition shadow-sm">
                                    關閉
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // ==========================================
        // APP COMPONENT 主程式
        // ==========================================
        const App = () => {
            const [currentMonth, setCurrentMonth] = useState("2026-01");
            const [activeTab, setActiveTab] = useState("daily");
            
            const [shiftDefs, setShiftDefs] = useState({});
            const [shiftOrder, setShiftOrder] = useState([]);
            
            const [scheduleData, setScheduleData] = useState({ headers: [], data: [] });
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            
            const [modalShift, setModalShift] = useState(null);

            const monthOptions = useMemo(() => generateMonthOptions(), []);
            const [selectedDayIndex, setSelectedDayIndex] = useState(0);
            
            // Personal View State
            const [selectedPersonId, setSelectedPersonId] = useState("");

            // 讀取 LocalStorage 中的使用者選擇
            useEffect(() => {
                const savedId = localStorage.getItem('lastSelectedPersonId');
                if (savedId) {
                    setSelectedPersonId(savedId);
                }
            }, []);

            // 更新選擇時寫入 LocalStorage
            const handlePersonChange = (e) => {
                const newId = e.target.value;
                setSelectedPersonId(newId);
                localStorage.setItem('lastSelectedPersonId', newId);
            };

            // ==========================================
            // SCROLL & AUTO-SELECT LOGIC
            // ==========================================
            const scrollRef = React.useRef(null);

            const scrollToDay = (index) => {
                setTimeout(() => {
                    const container = scrollRef.current;
                    const targetBtn = document.getElementById(`day-btn-${index}`);
                    
                    if (container && targetBtn) {
                        const scrollLeft = targetBtn.offsetLeft - (container.clientWidth / 2) + (targetBtn.clientWidth / 2);
                        container.scrollTo({ left: Math.max(0, scrollLeft), behavior: 'smooth' });
                    }
                }, 100); 
            };

            useEffect(() => {
                if (activeTab === 'daily') {
                    scrollToDay(selectedDayIndex);
                }
            }, [activeTab]);

            // ==========================================
            // FETCH DATA
            // ==========================================
            useEffect(() => {
                const fetchData = async () => {
                    setLoading(true);
                    setError(null);
                    setScheduleData({ headers: [], data: [] });

                    try {
                        let defsText, scheduleText;

                        if (USE_MOCK_DATA) {
                            await new Promise(r => setTimeout(r, 500));
                            defsText = MOCK_SHIFT_DEFS;
                            scheduleText = currentMonth === "2026-01" ? MOCK_SCHEDULE_2026_01 : "";
                            if (!scheduleText) throw new Error("模擬模式：僅提供 2026-01 資料範例。");
                        } else {
                            if (!GOOGLE_SPREADSHEET_ID) throw new Error("請設定 GOOGLE_SPREADSHEET_ID");
                            const baseUrl = `https://docs.google.com/spreadsheets/d/${GOOGLE_SPREADSHEET_ID}/gviz/tq?tqx=out:csv`;
                            const defsUrl = `${baseUrl}&sheet=${encodeURIComponent(SHIFT_DEF_SHEET_NAME)}`;
                            const scheduleUrl = `${baseUrl}&sheet=${encodeURIComponent(currentMonth)}`;
                            const [resDefs, resSched] = await Promise.all([fetch(defsUrl), fetch(scheduleUrl)]);
                            if (!resDefs.ok) throw new Error("讀取班別資料失敗");
                            if (!resSched.ok) throw new Error(`讀取 ${currentMonth} 班表失敗`);
                            defsText = await resDefs.text();
                            scheduleText = await resSched.text();
                        }
                        if (scheduleText.includes("<!DOCTYPE html")) throw new Error("無法讀取資料，請檢查權限設定。");
                        const { defs, order } = processShiftDefs(defsText);
                        setShiftDefs(defs);
                        setShiftOrder(order);
                        const processedSchedule = processSchedule(scheduleText);
                        if (processedSchedule.data.length === 0) throw new Error("無資料，請檢查 CSV 格式。");
                        setScheduleData(processedSchedule);
                    } catch (e) {
                        console.error(e);
                        setError(e.message);
                    } finally {
                        setLoading(false);
                    }
                };
                fetchData();
            }, [currentMonth]);

            useEffect(() => {
                if (scheduleData.headers.length === 0) return;
                const today = new Date();
                const currentYearMonth = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
                let targetIndex = 0;
                if (currentMonth === currentYearMonth) {
                    const todayDate = today.getDate(); 
                    const foundIndex = scheduleData.headers.findIndex(h => {
                        const hDay = parseInt(h.replace(/[^0-9]/g, ''));
                        return hDay === todayDate;
                    });
                    if (foundIndex !== -1) targetIndex = foundIndex;
                }
                setSelectedDayIndex(targetIndex);
                if (activeTab === 'daily') scrollToDay(targetIndex);
            }, [scheduleData, currentMonth]);

            // ==========================================
            // COLOR LOGIC & HANDLERS
            // ==========================================
            const getShiftStyle = (code) => {
                const c = (code || "").trim().toUpperCase();
                if (["O", "H", "N", "-", "D0"].includes(c)) return "bg-pink-50 text-pink-700 border-pink-200";
                if (["HA", "NN", "A"].includes(c) || c.includes("P")) return "bg-blue-50 text-blue-700 border-blue-200";
                if (c.includes("S") || c.includes("C")) return "bg-green-50 text-green-700 border-green-200";
                if (c.includes("D") || c.includes("U")) return "bg-yellow-50 text-yellow-700 border-yellow-200";
                return "bg-white border-gray-200 text-gray-700";
            };

            const getShiftInfo = (code) => {
                const cleanCode = (code || "").trim();
                return shiftDefs[cleanCode] || { time: "", desc: "" };
            };

            // 修改後的 handleShiftClick：接收更多上下文資訊 (index, 人員姓名)
            const handleShiftClick = (code, dayIndex = null, personName = null) => {
                const info = getShiftInfo(code);
                setModalShift({ 
                    code, 
                    ...info, 
                    dayIndex,       // 新增：第幾天
                    personName      // 新增：是誰點的
                });
            };

            const getTodayInfo = (personRow) => {
                if (!personRow || !scheduleData.headers) return null;
                const today = new Date();
                const todayYearMonth = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
                if (currentMonth !== todayYearMonth) return { isToday: false, msg: "非當月資料" };
                const dayOfMonth = today.getDate();
                const headerIndex = scheduleData.headers.findIndex(h => {
                    const hDay = parseInt(h.replace(/[^0-9]/g, ''));
                    return hDay === dayOfMonth;
                });
                if (headerIndex === -1) return { isToday: false, msg: "無今日資料" };
                const shiftCode = personRow[3 + headerIndex];
                const shiftInfo = getShiftInfo(shiftCode);
                return { isToday: true, dateStr: `${today.getMonth() + 1}/${dayOfMonth}`, shiftCode, shiftInfo };
            };

            if (loading && !scheduleData.data.length) {
                return (
                    <div className="flex items-center justify-center h-screen bg-gray-50 flex-col">
                        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
                        <p className="text-gray-500">正在讀取 {currentMonth} 班表...</p>
                    </div>
                );
            }

            return (
                <div className="min-h-screen pb-20 max-w-4xl mx-auto bg-white shadow-lg min-h-screen flex flex-col">
                    <header className="bg-blue-600 text-white p-4 sticky top-0 z-40 shadow-md">
                        <div className="flex justify-between items-center mb-4">
                            <h1 className="text-xl font-bold flex items-center gap-2">
                                <i data-lucide="calendar"></i>
                                線上排班系統
                            </h1>
                            <select 
                                value={currentMonth} 
                                onChange={(e) => setCurrentMonth(e.target.value)}
                                className="bg-blue-700 text-white border border-blue-500 rounded px-2 py-1 text-sm focus:outline-none"
                            >
                                {monthOptions.map(m => <option key={m} value={m}>{m}</option>)}
                            </select>
                        </div>
                        <div className="flex bg-blue-800 p-1 rounded-lg">
                            <button onClick={() => setActiveTab('daily')} className={`flex-1 py-2 text-sm font-medium rounded-md transition-all ${activeTab === 'daily' ? 'bg-white text-blue-800 shadow' : 'text-blue-200 hover:text-white'}`}>每日人員</button>
                            <button onClick={() => setActiveTab('personal')} className={`flex-1 py-2 text-sm font-medium rounded-md transition-all ${activeTab === 'personal' ? 'bg-white text-blue-800 shadow' : 'text-blue-200 hover:text-white'}`}>個人班表</button>
                        </div>
                    </header>

                    <main className="p-4 flex-grow">
                        {error ? (
                            <div className="bg-red-50 text-red-600 p-6 rounded-lg border border-red-200 text-center">
                                <i data-lucide="alert-circle" className="mx-auto mb-2 w-8 h-8 text-red-500"></i>
                                <h3 className="font-bold mb-2">無法讀取資料</h3>
                                <p className="text-sm">{error}</p>
                            </div>
                        ) : (
                            <>
                                {/* VIEW: DAILY (每日檢視) */}
                                {activeTab === 'daily' && scheduleData.headers.length > 0 && (
                                    <div className="animate-fade-in">
                                        <div 
                                            ref={scrollRef}
                                            className="flex overflow-x-auto pb-4 gap-2 hide-scrollbar mb-4 -mx-4 px-4 bg-gray-50 pt-2 border-b"
                                        >
                                            {scheduleData.headers.map((dayLabel, idx) => (
                                                <button
                                                    key={idx}
                                                    id={`day-btn-${idx}`}
                                                    onClick={() => setSelectedDayIndex(idx)}
                                                    className={`flex-shrink-0 w-14 h-16 flex flex-col items-center justify-center rounded-lg border transition-all ${
                                                        selectedDayIndex === idx 
                                                        ? 'bg-blue-600 text-white border-blue-600 shadow-md transform scale-105' 
                                                        : 'bg-white text-gray-600 border-gray-200 hover:border-blue-300'
                                                    }`}
                                                >
                                                    <span className="text-xs opacity-80">{dayLabel.replace(/[0-9]/g, '')}</span>
                                                    <span className="text-lg font-bold">{dayLabel.replace(/[^0-9]/g, '')}</span>
                                                </button>
                                            ))}
                                        </div>

                                        <h2 className="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                            <span className="bg-blue-100 text-blue-800 px-2 py-1 rounded mr-2 text-sm">
                                                {scheduleData.headers[selectedDayIndex]}
                                            </span>
                                            當日排班狀況
                                        </h2>

                                        <div className="flex flex-col gap-2">
                                            {(() => {
                                                const dayShifts = {};
                                                scheduleData.data.forEach(person => {
                                                    const shift = person[3 + selectedDayIndex]; 
                                                    if(!shift || shift === "-" || shift === "") return;
                                                    if(!dayShifts[shift]) dayShifts[shift] = [];
                                                    dayShifts[shift].push(person[2]);
                                                });

                                                const sortedShifts = Object.keys(dayShifts).sort((a, b) => {
                                                    const idxA = shiftOrder.indexOf(a);
                                                    const idxB = shiftOrder.indexOf(b);
                                                    if(idxA === -1 && idxB === -1) return 0;
                                                    if(idxA === -1) return 1;
                                                    if(idxB === -1) return -1;
                                                    return idxA - idxB;
                                                });

                                                if (sortedShifts.length === 0) return <div className="text-gray-400 text-center py-8 bg-gray-50 rounded-lg">本日無排班資料</div>;

                                                return sortedShifts.map(shiftCode => {
                                                    const isOff = ["O", "H", "U", "OFF", "-"].includes(shiftCode);
                                                    return (
                                                        <div 
                                                            key={shiftCode} 
                                                            onClick={() => handleShiftClick(shiftCode)}
                                                            className={`flex items-stretch rounded-lg border transition-colors cursor-pointer hover:shadow-md active:scale-[0.99] ${getShiftStyle(shiftCode)} ${isOff ? 'opacity-80' : ''}`}
                                                        >
                                                            <div className="w-20 flex-shrink-0 flex items-center justify-center border-r border-black/5 bg-black/5 font-bold text-xl p-2">
                                                                {shiftCode}
                                                            </div>
                                                            <div className="flex-grow p-3 flex flex-wrap gap-2 items-center bg-white/30">
                                                                {dayShifts[shiftCode].map(name => (
                                                                    <span key={name} className="bg-white border border-black/10 px-4 py-2 rounded-full text-xl font-bold text-gray-800 shadow-sm">
                                                                        {name}
                                                                    </span>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    );
                                                });
                                            })()}
                                        </div>
                                    </div>
                                )}

                                {/* VIEW: PERSONAL (個人檢視) */}
                                {activeTab === 'personal' && (
                                    <div className="animate-fade-in">
                                        
                                        <div className="mb-6 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                                            <label className="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">
                                                選擇人員 (系統將自動記憶)
                                            </label>
                                            <div className="relative">
                                                <select
                                                    value={selectedPersonId}
                                                    onChange={handlePersonChange}
                                                    className="w-full appearance-none bg-gray-50 border border-gray-300 text-gray-900 text-lg rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-3 pr-10"
                                                >
                                                    <option value="" disabled>請選擇人員...</option>
                                                    {scheduleData.data.map(p => (
                                                        <option key={p[1]} value={p[1]}>
                                                            {p[2]}
                                                        </option>
                                                    ))}
                                                </select>
                                                <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-500">
                                                    <i data-lucide="chevron-down" className="w-5 h-5"></i>
                                                </div>
                                            </div>
                                        </div>

                                        {selectedPersonId ? (() => {
                                            const person = scheduleData.data.find(p => p[1] === selectedPersonId);
                                            if (!person) return <div className="text-center text-gray-500">查無此人資料</div>;

                                            let workDays = 0, offDays = 0;
                                            person.slice(3).forEach(s => {
                                                if(["O", "H", "U", "OFF", "-"].includes(s)) offDays++;
                                                else if(s && s !== "") workDays++;
                                            });

                                            const todayData = getTodayInfo(person);
                                            let startCol = 1;
                                            if (scheduleData.headers.length > 0) {
                                                const firstDayStr = scheduleData.headers[0];
                                                if (firstDayStr.includes('日')) startCol = 1;
                                                else if (firstDayStr.includes('一')) startCol = 2;
                                                else if (firstDayStr.includes('二')) startCol = 3;
                                                else if (firstDayStr.includes('三')) startCol = 4;
                                                else if (firstDayStr.includes('四')) startCol = 5;
                                                else if (firstDayStr.includes('五')) startCol = 6;
                                                else if (firstDayStr.includes('六')) startCol = 7;
                                            }

                                            return (
                                                <div className="space-y-6">
                                                    
                                                    {/* 2. 當日班表 - 點擊可換班 */}
                                                    {todayData && todayData.isToday ? (
                                                        <div 
                                                            className={`rounded-xl border-l-8 shadow-lg overflow-hidden transform transition hover:scale-[1.02] cursor-pointer ${getShiftStyle(todayData.shiftCode)}`}
                                                            onClick={() => {
                                                                const dayStr = todayData.dateStr.split('/')[1]; 
                                                                const idx = scheduleData.headers.findIndex(h => parseInt(h.replace(/[^0-9]/g, '')) == dayStr);
                                                                handleShiftClick(todayData.shiftCode, idx, person[2]);
                                                            }}
                                                        >
                                                            <div className="p-5 flex justify-between items-center bg-white/40 backdrop-blur-sm">
                                                                <div>
                                                                    <div className="text-sm font-bold opacity-70 mb-1">
                                                                        今日班表 ({todayData.dateStr})
                                                                    </div>
                                                                    <div className="text-4xl font-black tracking-tight">
                                                                        {todayData.shiftCode}
                                                                    </div>
                                                                </div>
                                                                <div className="text-right">
                                                                    <div className="text-lg font-bold">
                                                                        {todayData.shiftInfo.time || "無時間"}
                                                                    </div>
                                                                    <div className="text-xs opacity-70 max-w-[150px] truncate">
                                                                        {todayData.shiftInfo.desc}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    ) : (
                                                        <div className="bg-gray-100 rounded-xl p-4 text-center text-gray-400 text-sm border border-dashed border-gray-300">
                                                            {todayData ? todayData.msg : "無法顯示今日資訊"}
                                                        </div>
                                                    )}

                                                    {/* 個人資訊卡 */}
                                                    <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-4 flex justify-between items-center">
                                                        <div>
                                                            <h2 className="text-2xl font-black text-gray-800">{person[2]}</h2>
                                                        </div>
                                                        <div className="flex gap-4 text-sm">
                                                            <div className="text-center">
                                                                <div className="font-bold text-gray-800">{workDays}</div>
                                                                <div className="text-xs text-gray-500">出勤</div>
                                                            </div>
                                                            <div className="text-center">
                                                                <div className="font-bold text-gray-800">{offDays}</div>
                                                                <div className="text-xs text-gray-500">休假</div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    {/* 3. 月曆模式呈現 */}
                                                    <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                                                        <div className="grid grid-cols-7 bg-gray-50 border-b border-gray-200 text-center py-2 text-xs font-bold text-gray-500">
                                                            <div className="text-red-400">日</div>
                                                            <div>一</div>
                                                            <div>二</div>
                                                            <div>三</div>
                                                            <div>四</div>
                                                            <div>五</div>
                                                            <div className="text-green-600">六</div>
                                                        </div>
                                                        <div className="grid grid-cols-7 gap-px bg-gray-200">
                                                            {scheduleData.headers.map((date, idx) => {
                                                                const shiftCode = person[3 + idx];
                                                                const dayNum = date.replace(/[^0-9]/g, '');
                                                                const style = getShiftStyle(shiftCode);
                                                                const gridClass = idx === 0 ? `col-start-${startCol}` : '';

                                                                return (
                                                                    <div 
                                                                        key={idx} 
                                                                        className={`bg-white min-h-[80px] p-1 flex flex-col justify-between hover:bg-blue-50 cursor-pointer transition group ${gridClass}`}
                                                                        onClick={() => handleShiftClick(shiftCode, idx, person[2])}
                                                                    >
                                                                        <div className="flex justify-between items-start">
                                                                            <div className="text-xs text-gray-400 font-medium pl-1 group-hover:text-blue-600">
                                                                                {dayNum}
                                                                            </div>
                                                                        </div>
                                                                        
                                                                        {shiftCode && shiftCode !== "-" ? (
                                                                            <div className={`text-center py-1 rounded mx-1 font-bold text-sm shadow-sm border ${style.replace('border-l-4', '')}`}>
                                                                                {shiftCode}
                                                                            </div>
                                                                        ) : (
                                                                            <div className="h-6"></div>
                                                                        )}
                                                                        
                                                                        <div className="h-2"></div>
                                                                    </div>
                                                                );
                                                            })}
                                                        </div>
                                                    </div>

                                                </div>
                                            );
                                        })() : (
                                            <div className="text-center py-16 bg-white rounded-xl shadow-sm border border-gray-100">
                                                <div className="bg-blue-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-500">
                                                    <i data-lucide="user" className="w-8 h-8"></i>
                                                </div>
                                                <h3 className="text-lg font-bold text-gray-800 mb-2">請選擇人員</h3>
                                                <p className="text-gray-500 text-sm">選擇後系統將自動記住您的身份</p>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </>
                        )}
                    </main>

                    {/* 修改處：傳入 scheduleData 與 currentMonth 以供換班功能使用 */}
                    <ShiftDetailModal 
                        shiftInfo={modalShift} 
                        onClose={() => setModalShift(null)} 
                        scheduleData={scheduleData}
                        currentMonth={currentMonth}
                    />

                    <footer className="bg-white border-t border-gray-200 p-4 text-center text-xs text-gray-400 mt-auto">
                        © 2026 線上排班系統 | 資料來源: Google Sheets
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
        
        setTimeout(() => {
            if(window.lucide) window.lucide.createIcons();
        }, 500);
    </script>
</body>
</html>
