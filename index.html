<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>藥局班表 (最終診斷版)</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        [v-cloak] { display: none; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #0d9488; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

<div id="app" v-cloak class="max-w-md mx-auto min-h-screen bg-white shadow-xl flex flex-col">
    
    <header class="bg-teal-700 text-white p-4 flex justify-between items-center shadow">
        <h1 class="font-bold text-lg"><i class="fas fa-stethoscope mr-2"></i>藥局班表</h1>
        <div class="text-xs bg-teal-800 px-2 py-1 rounded">診斷模式</div>
    </header>

    <div v-if="envError" class="p-6 bg-red-100 text-red-800 border-b-4 border-red-500">
        <h2 class="font-bold text-xl mb-2"><i class="fas fa-exclamation-circle"></i> 環境錯誤</h2>
        <p class="font-bold">{{ envError }}</p>
        <p class="text-sm mt-2 text-gray-600">請將檔案上傳至 GitHub Pages，並使用 https:// 網址開啟。</p>
    </div>

    <div v-else-if="errorMsg" class="flex-1 flex flex-col items-center justify-center p-6 text-center">
        <div class="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center text-3xl mb-4">
            <i class="fas fa-wifi"></i>
        </div>
        <h3 class="text-xl font-bold text-gray-800 mb-2">讀取失敗</h3>
        <div class="bg-gray-100 p-3 rounded text-left text-xs font-mono text-red-600 w-full mb-4 break-all border border-gray-300">
            {{ errorMsg }}
        </div>
        
        <div class="text-sm text-gray-500 space-y-2 mb-6 text-left w-full px-4">
            <p><strong>可能原因：</strong></p>
            <ul class="list-disc pl-5">
                <li><strong>醫院防火牆擋住了：</strong>請改用手機 4G/5G 網路測試。</li>
                <li><strong>網址錯誤：</strong>請檢查 index.html 內的 API 網址。</li>
                <li><strong>權限不足：</strong>GAS 部署必須設定為「所有使用者 (Anyone)」。</li>
            </ul>
        </div>

        <button @click="init" class="bg-teal-600 text-white px-6 py-2 rounded-lg shadow active:scale-95 transition">
            再試一次
        </button>
    </div>

    <div v-else-if="loading" class="flex-1 flex flex-col items-center justify-center">
        <div class="spinner mb-4"></div>
        <p class="text-gray-500 animate-pulse">正在連線 Google 資料庫...</p>
        <p class="text-xs text-gray-400 mt-2">若是第一次開啟可能會較慢</p>
    </div>

    <main v-else class="flex-1 overflow-y-auto p-4">
        <div class="mb-4">
            <label class="text-xs text-gray-500 block mb-1">選擇月份</label>
            <select v-model="currentSheet" @change="fetchScheduleData" class="w-full p-2 border rounded bg-gray-50">
                <option v-for="s in sheetList" :key="s" :value="s">{{ s }}</option>
            </select>
        </div>

        <div v-for="(group, title) in staffByTitle" :key="title" class="mb-6">
            <h3 class="text-sm font-bold text-gray-500 mb-2 border-l-4 border-teal-500 pl-2">{{ title }}</h3>
            <div class="space-y-2">
                <div v-for="person in group" :key="person.id" class="flex justify-between items-center bg-white p-3 rounded-lg border shadow-sm">
                    <div>
                        <div class="font-bold text-gray-800">{{ person.name }}</div>
                        <div class="text-xs text-gray-400">{{ person.id }}</div>
                    </div>
                    <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded text-sm font-bold">
                        {{ person.todayShift }}
                    </span>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
    const { createApp } = Vue;

    // -----------------------------------------------------------
    // 設定區：你的 API 網址 (已確認格式正確)
    // -----------------------------------------------------------
    const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbw1yyWwV2yGjBR3ZSd62W1KyQCt5ER9MM5QXcNmTQ8io0JWHOGX66FMN4r5ocw7BQ/exec';

    createApp({
        data() {
            return {
                loading: true,
                errorMsg: '',
                envError: '',
                sheetList: [],
                currentSheet: '',
                allStaff: [],
                selectedDateIndex: new Date().getDate(),
            }
        },
        computed: {
            staffByTitle() {
                const grouped = {};
                this.allStaff.forEach(p => {
                    p.todayShift = p.schedule[this.selectedDateIndex] || '-';
                    if (!grouped[p.title]) grouped[p.title] = [];
                    grouped[p.title].push(p);
                });
                return grouped;
            }
        },
        mounted() {
            // 1. 檢查是否為本機開啟 (file://)
            if (window.location.protocol === 'file:') {
                this.envError = '錯誤：請勿直接點擊檔案開啟 (file://)。因為安全性限制，這樣無法讀取雲端資料。';
                this.loading = false;
                alert(this.envError);
                return;
            }
            this.init();
        },
        methods: {
            async init() {
                this.loading = true;
                this.errorMsg = '';
                try {
                    // 加上時間戳記，避免快取
                    const url = `${GAS_API_URL}?op=get_months&t=${Date.now()}`;
                    
                    // 使用最基礎的 fetch
                    const res = await fetch(url, { redirect: 'follow' });
                    
                    if (!res.ok) {
                        throw new Error(`伺服器回應錯誤 (Status: ${res.status})`);
                    }

                    const text = await res.text();
                    
                    // 檢查是否被導向到 Google 登入頁 (常見權限錯誤)
                    if (text.includes('<!DOCTYPE html>') || text.includes('Google Accounts')) {
                        throw new Error('權限不足：讀取到的是 Google 登入頁面，請檢查 GAS 部署設定是否為「所有使用者 (Anyone)」。');
                    }

                    try {
                        const json = JSON.parse(text);
                        if (json.status === 'success') {
                            this.sheetList = json.data;
                            if (this.sheetList.length > 0) {
                                this.currentSheet = this.sheetList[this.sheetList.length - 1];
                                this.fetchScheduleData();
                            } else {
                                throw new Error('讀取成功，但試算表中沒有任何工作表。');
                            }
                        } else {
                            throw new Error(json.message || 'API 回傳未知錯誤');
                        }
                    } catch (e) {
                        throw new Error('資料格式錯誤 (非 JSON)，可能是網址錯誤或防火牆攔截內容。');
                    }

                } catch (e) {
                    // 這裡是關鍵：如果是 Failed to fetch，通常是網路問題
                    let msg = e.message;
                    if (msg === 'Failed to fetch') {
                        msg = '網路連線被阻擋 (Failed to fetch)。請檢查是否被醫院防火牆攔截，或未上傳至 GitHub。';
                    }
                    this.errorMsg = msg;
                    this.loading = false;
                    
                    // 彈窗警告
                    alert("連線失敗：\n" + msg);
                }
            },

            async fetchScheduleData() {
                this.loading = true;
                try {
                    const url = `${GAS_API_URL}?op=get_data&sheet=${encodeURIComponent(this.currentSheet)}&t=${Date.now()}`;
                    const res = await fetch(url, { redirect: 'follow' });
                    const json = await res.json();

                    if (json.status === 'success') {
                        this.parseData(json.data);
                    } else {
                        throw new Error(json.message);
                    }
                } catch (e) {
                    this.errorMsg = '讀取班表失敗：' + e.message;
                    alert(this.errorMsg);
                }
                this.loading = false;
            },

            parseData(data) {
                if (!data || data.length < 2) return;
                const headers = data[0];
                
                // 簡易偵測日期欄位
                let dateStartIndex = 3;
                for(let i=0; i<headers.length; i++) {
                     if(!isNaN(parseInt(headers[i]))) {
                         dateStartIndex = i;
                         break;
                     }
                }

                const days = [];
                for (let i = dateStartIndex; i < headers.length; i++) {
                    const d = parseInt(headers[i]);
                    if (!isNaN(d)) days.push(d);
                }

                this.allStaff = data.slice(1).map(row => {
                    const schedule = {};
                    days.forEach((d, idx) => {
                        schedule[d] = row[idx + dateStartIndex] ? row[idx + dateStartIndex].toString().trim() : '';
                    });
                    return { title: row[0], id: row[1], name: row[2], schedule: schedule, todayShift: '' };
                });
            }
        }
    });
</script>
</body>
</html>

