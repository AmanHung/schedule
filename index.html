<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è—¥å±€ç·šä¸Šæ’ç­ç³»çµ± (é™¤éŒ¯ç‰ˆ)</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .loading-spinner { border-top-color: #0D9488; animation: spinner 1s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        [v-cloak] { display: none; }
        body { touch-action: manipulation; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">

<div id="app" v-cloak class="max-w-md mx-auto min-h-screen bg-white shadow-2xl relative flex flex-col">
    
    <header class="bg-teal-700 text-white p-4 sticky top-0 z-50 shadow-lg">
        <div class="flex justify-between items-center">
            <h1 class="text-lg font-bold flex items-center">
                <i class="fas fa-prescription-bottle-alt mr-2"></i> è—¥å±€ç­è¡¨
            </h1>
            <button @click="init" class="bg-red-500 text-white text-xs px-2 py-1 rounded hover:bg-red-600">
                <i class="fas fa-sync"></i> é‡é€£
            </button>
        </div>
    </header>

    <div v-if="loading" class="flex-1 flex flex-col items-center justify-center min-h-[50vh]">
        <div class="loading-spinner ease-linear rounded-full border-4 border-t-4 border-gray-200 h-10 w-10 mb-3"></div>
        <p class="text-gray-500 text-sm animate-pulse">æ­£åœ¨è®€å–é›²ç«¯è³‡æ–™åº«...</p>
        <p class="text-xs text-gray-400 mt-2">è«‹ç•™æ„ç€è¦½å™¨ Console è¨Šæ¯</p>
    </div>

    <div v-else-if="errorMsg" class="flex-1 flex flex-col items-center justify-center p-8 text-center">
        <div class="bg-red-50 text-red-600 p-4 rounded-full mb-4"><i class="fas fa-wifi text-2xl"></i></div>
        <h3 class="font-bold text-lg mb-2">è®€å–å¤±æ•—</h3>
        <p class="text-sm text-gray-500 mb-6 whitespace-pre-line">{{ errorMsg }}</p>
        <button @click="init" class="px-6 py-2 bg-teal-600 text-white rounded-lg shadow active:scale-95 transition">é‡è©¦</button>
    </div>

    <main v-else class="flex-1 overflow-y-auto pb-20">
        <div class="p-4 text-center">
            <h2 class="text-green-600 font-bold text-xl mb-2">é€£ç·šæˆåŠŸï¼</h2>
            <p class="text-gray-600">ç›®å‰æœˆä»½ï¼š{{ currentSheet }}</p>
            <p class="text-gray-500 text-sm mt-4">å…±æœ‰ {{ allStaff.length }} ä½äººå“¡è³‡æ–™</p>
            
            <div class="mt-6 border p-4 rounded bg-gray-50 text-left text-xs font-mono overflow-auto max-h-60">
                {{ allStaff }}
            </div>
        </div>
    </main>
</div>

<script>
    const { createApp } = Vue;

    // ==========================================
    // ã€è«‹å¡«å…¥ä½ çš„æ–°ç¶²å€ã€‘
    // è¨˜å¾—ï¼šçµå°¾æ˜¯ /execï¼Œä¸è¦æœ‰ç©ºç™½
    // ==========================================
    const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbwy8wbREmeuYvQwSWcJgq_56ulQQQG09i4ggMp_HqxExH5jmG4MwRtl3e0HiydUfdnR/exec'; 

    createApp({
        data() {
            return {
                loading: true,
                errorMsg: '',
                sheetList: [], 
                currentSheet: '', 
                allStaff: [],
            }
        },
        mounted() {
            // æ¸¬è©¦ Vue æ˜¯å¦æ´»è‘—
            console.log("Vue Mounted æˆåŠŸå•Ÿå‹•ï¼");
            
            // æª¢æŸ¥æ˜¯å¦å¿˜è¨˜å¡«ç¶²å€
            if (GAS_API_URL.includes("ä½ çš„ GAS éƒ¨ç½²ç¶²å€")) {
                this.errorMsg = "è«‹ä¿®æ”¹ç¨‹å¼ç¢¼ï¼Œå¡«å…¥æ­£ç¢ºçš„ GAS_API_URL";
                this.loading = false;
                alert("æé†’ï¼šä½ é‚„æ²’å¡«å…¥ GAS ç¶²å€å–”ï¼");
                return;
            }

            this.init();
        },
        methods: {
            async init() {
                this.loading = true;
                this.errorMsg = '';
                
                const cleanUrl = GAS_API_URL.trim();
                console.log("ğŸš€ [1/5] æº–å‚™é€£ç·šè‡³:", cleanUrl);

                try {
                    const url = new URL(cleanUrl);
                    url.searchParams.set('op', 'get_months');
                    console.log("ğŸ”— [2/5] å®Œæ•´è«‹æ±‚ç¶²å€:", url.toString());

                    const res = await fetch(url.toString(), { 
                        method: 'GET',
                        redirect: 'follow'
                    });
                    
                    console.log("ğŸ“¡ [3/5] HTTP ç‹€æ…‹ç¢¼:", res.status);

                    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                    
                    const textData = await res.text();
                    console.log("ğŸ“¦ [4/5] ä¼ºæœå™¨å›å‚³åŸå§‹è³‡æ–™:", textData);
                    
                    let json;
                    try {
                        json = JSON.parse(textData);
                    } catch (e) {
                        if (textData.includes("<!DOCTYPE html>")) {
                            throw new Error("æ¬Šé™éŒ¯èª¤ï¼šå›å‚³äº† HTMLã€‚è«‹æª¢æŸ¥ GAS éƒ¨ç½²æ˜¯å¦ç‚ºã€Œä»»ä½•äºº (Anyone)ã€");
                        }
                        throw new Error("JSON è§£æå¤±æ•—: " + e.message);
                    }
                    
                    if (json.status === 'success') {
                        console.log("âœ… [5/5] è³‡æ–™è§£ææˆåŠŸ:", json.data);
                        this.sheetList = json.data;
                        if (this.sheetList.length > 0) {
                            this.currentSheet = this.sheetList[this.sheetList.length - 1];
                            // é€™è£¡æˆ‘å€‘åªå…ˆé¡¯ç¤ºé€£ç·šæˆåŠŸï¼Œæš«ä¸æŠ“è©³ç´°ç­è¡¨ï¼Œç¢ºä¿ç¬¬ä¸€æ­¥é€šäº†å†èªª
                            this.loading = false; 
                        } else {
                            this.errorMsg = "è³‡æ–™åº«ä¸­æ‰¾ä¸åˆ°ä»»ä½•æœˆä»½è³‡æ–™";
                            this.loading = false;
                        }
                    } else {
                        throw new Error(json.message || "æœªçŸ¥çš„ API éŒ¯èª¤");
                    }
                } catch (e) {
                    console.error("âŒ è©³ç´°éŒ¯èª¤:", e);
                    this.errorMsg = "é€£ç·šå¤±æ•—ï¼š" + e.message;
                    this.loading = false;
                }
            }
        }
    }).mount('#app');
</script>
</body>
</html>
