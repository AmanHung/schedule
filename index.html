<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>藥局線上排班系統 (除錯模式)</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .loading-spinner { border-top-color: #0D9488; animation: spinner 1s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        [v-cloak] { display: none; }
        /* 除錯視窗樣式 */
        #debug-console {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 200px;
            background: rgba(0,0,0,0.9); color: #00ff00; font-family: monospace;
            font-size: 12px; padding: 10px; overflow-y: auto; z-index: 9999;
            border-top: 2px solid #00ff00;
        }
        .log-error { color: #ff5555; font-weight: bold; }
        .log-warn { color: #ffff55; }
        .log-info { color: #ffffff; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans pb-[220px]">

<div id="app" v-cloak class="max-w-md mx-auto min-h-screen bg-white shadow-2xl relative flex flex-col">
    
    <header class="bg-teal-700 text-white p-4 sticky top-0 z-50 shadow-lg flex justify-between items-center">
        <h1 class="text-lg font-bold"><i class="fas fa-prescription-bottle-alt mr-2"></i> 藥局班表</h1>
        <select v-model="currentSheet" @change="fetchScheduleData" class="text-black text-sm rounded px-2 py-1">
            <option v-for="sheet in sheetList" :key="sheet" :value="sheet">{{ sheet }}</option>
        </select>
    </header>

    <div v-if="loading" class="flex-1 flex flex-col items-center justify-center min-h-[50vh]">
        <div class="loading-spinner rounded-full border-4 border-t-4 border-gray-200 h-10 w-10 mb-3"></div>
        <p class="text-gray-500 text-sm">正在連線雲端資料庫...</p>
    </div>

    <div v-else-if="errorMsg" class="p-8 text-center text-red-600 bg-red-50 m-4 rounded-lg">
        <i class="fas fa-bug text-4xl mb-2"></i>
        <h3 class="font-bold text-lg">讀取失敗</h3>
        <p class="text-sm mt-2">{{ errorMsg }}</p>
        <button @click="init" class="mt-4 px-6 py-2 bg-teal-600 text-white rounded shadow">重試</button>
    </div>

    <main v-else class="p-4">
        <div v-if="currentView === 'daily'">
            <div class="flex items-center justify-between mb-4 bg-gray-50 p-2 rounded border">
                <button @click="changeDay(-1)" class="p-2"><i class="fas fa-chevron-left"></i></button>
                <div class="text-center">
                    <div class="text-xl font-bold">{{ selectedDateIndex }}日 <span class="text-sm">({{ getWeekDay(selectedDateIndex) }})</span></div>
                </div>
                <button @click="changeDay(1)" class="p-2"><i class="fas fa-chevron-right"></i></button>
            </div>
            
            <div v-for="(group, title) in staffByTitle" :key="title" class="mb-4">
                <h3 class="text-sm font-bold text-gray-500 mb-2">{{ title }}</h3>
                <div class="space-y-2">
                    <div v-for="person in group" :key="person.id" @click="viewPerson(person)"
                         class="flex justify-between items-center bg-white p-3 rounded shadow-sm border border-gray-200">
                        <span class="font-bold">{{ person.name }}</span>
                        <span :class="['px-3 py-1 rounded text-sm font-bold', getShiftStyle(person.todayShift)]">
                            {{ person.todayShift || '-' }}
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="currentView === 'personal'">
            <button @click="currentView = 'daily'" class="mb-4 text-blue-500">
                <i class="fas fa-arrow-left"></i> 返回
            </button>
            <h2 class="text-2xl font-bold mb-4 text-center">{{ selectedPerson.name }}</h2>
            <div class="grid grid-cols-7 gap-1">
                <div v-for="d in ['日','一','二','三','四','五','六']" class="text-center text-xs text-gray-400">{{ d }}</div>
                <div v-for="(shift, dateIdx) in selectedPerson.schedule" :key="dateIdx"
                     class="border p-1 rounded min-h-[50px] flex flex-col items-center justify-center"
                     :class="dateIdx == selectedDateIndex ? 'border-teal-500 ring-2' : ''">
                    <span class="text-xs text-gray-400">{{ dateIdx }}</span>
                    <span :class="['text-sm font-bold', getShiftTextStyle(shift)]">{{ shift }}</span>
                </div>
            </div>
        </div>
    </main>
</div>

<div id="debug-console">
    <div><strong>--- 系統除錯紀錄 (請截圖此處) ---</strong></div>
</div>

<script>
    // ----------------------------------------
    // 1. 強制覆寫 Console，讓錯誤顯示在螢幕上
    // ----------------------------------------
    (function(){
        const oldLog = console.log;
        const oldError = console.error;
        const oldWarn = console.warn;
        const debugDiv = document.getElementById('debug-console');

        function printToScreen(msg, type) {
            const div = document.createElement('div');
            div.className = type === 'error' ? 'log-error' : (type === 'warn' ? 'log-warn' : 'log-info');
            div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            debugDiv.appendChild(div);
            debugDiv.scrollTop = debugDiv.scrollHeight;
        }

        console.log = function(...args) {
            oldLog.apply(console, args);
            printToScreen(args.join(' '), 'info');
        };
        console.error = function(...args) {
            oldError.apply(console, args);
            printToScreen(args.join(' '), 'error');
        };
        console.warn = function(...args) {
            // 忽略 Tailwind 警告
            if(args[0] && typeof args[0] === 'string' && args[0].includes('cdn.tailwindcss.com')) return;
            oldWarn.apply(console, args);
            printToScreen(args.join(' '), 'warn');
        };
    })();

    const { createApp } = Vue;

    // ----------------------------------------
    // 2. 你的 API 網址 (我已經修復了換行問題)
    // ----------------------------------------
    const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbw1yyWwV2yGjBR3ZSd62W1KyQCt5ER9MM5QXcNmTQ8io0JWHOGX66FMN4r5ocw7BQ/exec';

    const SHIFT_DATA = {
        'D': { style: 'bg-blue-100 text-blue-800' }, 'E': { style: 'bg-orange-100 text-orange-800' },
        'N': { style: 'bg-purple-100 text-purple-800' }, 'O': { style: 'bg-gray-100 text-gray-400' },
        'H': { style: 'bg-red-50 text-red-600' }, 'DEFAULT': { style: 'bg-white text-gray-700 border' }
    };

    createApp({
        data() {
            return {
                loading: true,
                errorMsg: '',
                sheetList: [],
                currentSheet: '',
                currentView: 'daily',
                allStaff: [],
                daysInSheet: [],
                headerWeekDays: {},
                selectedDateIndex: new Date().getDate(),
                selectedPerson: null
            }
        },
        computed: {
            staffByTitle() {
                const grouped = {};
                this.allStaff.forEach(p => {
                    p.todayShift = p.schedule[this.selectedDateIndex];
                    if (!grouped[p.title]) grouped[p.title] = [];
                    grouped[p.title].push(p);
                });
                return grouped;
            }
        },
        mounted() {
            console.log("Vue App 已啟動，準備連線...");
            console.log("API URL: " + GAS_API_URL);
            this.init();
        },
        methods: {
            async init() {
                this.loading = true;
                this.errorMsg = '';
                try {
                    // 加入時間戳記避免快取
                    const targetUrl = `${GAS_API_URL}?op=get_months&t=${Date.now()}`;
                    console.log("正在發送請求到: " + targetUrl);

                    const res = await fetch(targetUrl, { redirect: 'follow' });
                    console.log("伺服器回應狀態: " + res.status);

                    if (!res.ok) throw new Error(`HTTP Error: ${res.status}`);

                    const textData = await res.text();
                    console.log("收到原始資料(前50字): " + textData.substring(0, 50));

                    // 檢查是否是 Google 登入頁面 (常見錯誤)
                    if (textData.includes("<!DOCTYPE html>") || textData.includes("Google Accounts")) {
                        throw new Error("權限錯誤：讀取到的是 Google 登入頁面，請檢查 GAS 部署權限是否為 'Anyone'。");
                    }

                    const json = JSON.parse(textData);
                    if (json.status === 'success') {
                        console.log("月份列表讀取成功: " + json.data);
                        this.sheetList = json.data;
                        if (this.sheetList.length > 0) {
                            this.currentSheet = this.sheetList[this.sheetList.length - 1];
                            this.fetchScheduleData();
                        }
                    } else {
                        throw new Error(json.message);
                    }
                } catch (e) {
                    console.error("初始化失敗: " + e.message);
                    this.errorMsg = e.message;
                    this.loading = false;
                }
            },

            async fetchScheduleData() {
                this.loading = true;
                try {
                    const targetUrl = `${GAS_API_URL}?op=get_data&sheet=${this.currentSheet}&t=${Date.now()}`;
                    console.log("正在讀取班表資料: " + this.currentSheet);
                    
                    const res = await fetch(targetUrl, { redirect: 'follow' });
                    const textData = await res.text();
                    const json = JSON.parse(textData);

                    if (json.status === 'success') {
                        console.log("班表資料讀取成功，開始解析...");
                        this.parseData(json.data);
                    } else {
                        throw new Error(json.message);
                    }
                } catch (e) {
                    console.error("讀取班表失敗: " + e.message);
                    this.errorMsg = e.message;
                }
                this.loading = false;
            },

            parseData(data) {
                if (!data || data.length < 2) return;
                const headers = data[0];
                this.daysInSheet = [];
                this.headerWeekDays = {};
                
                // 自動偵測日期開始的欄位 (找第一個是數字的欄位)
                let dateStartIndex = 3; 
                for(let i=0; i<headers.length; i++) {
                     if(!isNaN(parseInt(headers[i]))) {
                         dateStartIndex = i;
                         break;
                     }
                }
                console.log("日期欄位偵測從 Index " + dateStartIndex + " 開始");

                for (let i = dateStartIndex; i < headers.length; i++) {
                    const d = parseInt(headers[i]);
                    if (!isNaN(d)) {
                        this.daysInSheet.push(d);
                        const match = headers[i].toString().match(/\((.*?)\)/);
                        if (match) this.headerWeekDays[d] = match[1];
                    }
                }

                this.allStaff = data.slice(1).map(row => {
                    const schedule = {};
                    this.daysInSheet.forEach((d, idx) => {
                        schedule[d] = row[idx + dateStartIndex] ? row[idx + dateStartIndex].toString().trim() : '';
                    });
                    return { title: row[0], id: row[1], name: row[2], schedule: schedule, todayShift: '' };
                });
                console.log("人員解析完成，共 " + this.allStaff.length + " 人");
            },

            getShiftStyle(code) {
                if (!code) return 'bg-white';
                const char = code.charAt(0);
                if (SHIFT_DATA[code]) return SHIFT_DATA[code].style;
                if (SHIFT_DATA[char]) return SHIFT_DATA[char].style;
                if (char === 'A' || char === 'E') return SHIFT_DATA['E'].style; // 小夜
                if (char === 'S') return 'bg-green-100 text-green-800'; // 半天
                return SHIFT_DATA['DEFAULT'].style;
            },
            
            getShiftTextStyle(code) {
                 const style = this.getShiftStyle(code);
                 if(style.includes('text-red')) return 'text-red-600';
                 if(style.includes('text-blue')) return 'text-blue-600';
                 if(style.includes('text-purple')) return 'text-purple-600';
                 if(style.includes('text-orange')) return 'text-orange-600';
                 return 'text-gray-600';
            },

            getWeekDay(d) { return this.headerWeekDays[d] || ''; },
            
            changeDay(delta) {
                const idx = this.daysInSheet.indexOf(this.selectedDateIndex);
                let next = idx + delta;
                if(next >= 0 && next < this.daysInSheet.length) this.selectedDateIndex = this.daysInSheet[next];
            },
            
            viewPerson(p) { this.selectedPerson = p; this.currentView = 'personal'; }
        }
    });
</script>
</body>
</html>
