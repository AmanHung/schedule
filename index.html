<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>線上排班系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // ==========================================
        // CONFIGURATION 設定區
        // ==========================================
        const GOOGLE_SPREADSHEET_ID = "1OfGyESqORhCNdQRm7kVQkF9jirkpZPO1FNnZxmzFIZc"; 
        const SHIFT_DEF_SHEET_NAME = "班別資料"; 

        // ==========================================
        // HOLIDAYS 2026 (民國115年) 國定假日設定
        // ==========================================
        const HOLIDAYS = {
            "2026-01-01": "元旦",
            "2026-02-16": "除夕",
            "2026-02-17": "春節",
            "2026-02-18": "初二",
            "2026-02-19": "初三",
            "2026-02-20": "春節補假",
            "2026-02-27": "和平紀念日補假",
            "2026-02-28": "和平紀念日",
            "2026-04-03": "兒童節補假",
            "2026-04-04": "兒童節",
            "2026-04-05": "清明節",
            "2026-04-06": "清明節補假",
            "2026-05-01": "勞動節",
            "2026-06-19": "端午節",
            "2026-09-25": "中秋節",
            "2026-09-28": "教師節",
            "2026-10-09": "國慶日補假",
            "2026-10-10": "國慶日",
            "2026-10-25": "光復節",
            "2026-10-26": "光復節補假",
            "2026-12-25": "行憲紀念日"
        };

        // ==========================================
        // HELPER FUNCTIONS 工具函式
        // ==========================================
        
        const parseCSV = (text) => {
            const rows = [];
            let currentRow = [];
            let currentCell = '';
            let inQuotes = false;

            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                const nextChar = text[i + 1];

                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        currentCell += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    currentRow.push(currentCell.trim());
                    currentCell = '';
                } else if ((char === '\r' || char === '\n') && !inQuotes) {
                    if (char === '\r' && nextChar === '\n') i++;
                    if (currentCell || currentRow.length > 0) {
                        currentRow.push(currentCell.trim());
                        rows.push(currentRow);
                    }
                    currentRow = [];
                    currentCell = '';
                } else {
                    currentCell += char;
                }
            }
            if (currentCell || currentRow.length > 0) {
                currentRow.push(currentCell.trim());
                rows.push(currentRow);
            }
            return rows;
        };

        const processShiftDefs = (csvText) => {
            const rows = parseCSV(csvText);
            const defs = {};
            const order = [];
            
            for(let i=1; i<rows.length; i++) {
                if (rows[i].length < 2) continue;
                const [code, hours, time, desc] = rows[i];
                if(code) {
                    const cleanCode = code.trim();
                    defs[cleanCode] = { hours, time, desc };
                    order.push(cleanCode);
                }
            }
            return { defs, order };
        };

        const processSchedule = (csvText) => {
            const rows = parseCSV(csvText);
            let headerRowIndex = rows.findIndex(row => row.includes("姓名"));
            if (headerRowIndex === -1) return { headers: [], data: [] };

            const headers = rows[headerRowIndex];
            const data = rows.slice(headerRowIndex + 1).filter(row => row.length > 3 && row[2]); 

            const dateHeaders = headers.slice(3).map(h => h);
            return { headers: dateHeaders, data, rawHeaders: headers };
        };

        // ==========================================
        // COMPONENT: SHIFT DETAILS MODAL
        // ==========================================
        const ShiftDetailModal = ({ shiftInfo, onClose }) => {
            if (!shiftInfo) return null;
            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm animate-fade-in" onClick={onClose}>
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden" onClick={e => e.stopPropagation()}>
                        <div className="bg-blue-600 p-4 text-white flex justify-between items-center">
                            <h3 className="text-xl font-bold flex items-center gap-2">
                                <span className="bg-white text-blue-600 px-2 rounded text-sm font-black">{shiftInfo.code}</span>
                                班別詳情
                            </h3>
                            <button onClick={onClose} className="hover:bg-blue-700 p-1 rounded transition">
                                <i data-lucide="x" className="w-5 h-5"></i>
                            </button>
                        </div>
                        <div className="p-6 space-y-4">
                            <div>
                                <label className="text-xs font-bold text-gray-400 uppercase tracking-wider block mb-1">工作時間</label>
                                <div className="text-lg font-medium text-gray-800 bg-gray-50 p-3 rounded border border-gray-100">
                                    {shiftInfo.time || "無時間資料"}
                                </div>
                            </div>
                            <div>
                                <label className="text-xs font-bold text-gray-400 uppercase tracking-wider block mb-1">說明</label>
                                <div className="text-gray-600 whitespace-pre-wrap leading-relaxed">
                                    {shiftInfo.desc || "無說明內容"}
                                </div>
                            </div>
                        </div>
                        <div className="bg-gray-50 p-4 border-t border-gray-100 text-center">
                            <button onClick={onClose} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition shadow-sm">
                                關閉
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // ==========================================
        // APP COMPONENT 主程式
        // ==========================================
        const App = () => {
            const [currentMonth, setCurrentMonth] = useState("2026-01");
            const [activeTab, setActiveTab] = useState("daily");
            
            const [shiftDefs, setShiftDefs] = useState({});
            const [shiftOrder, setShiftOrder] = useState([]);
            
            const [scheduleData, setScheduleData] = useState({ headers: [], data: [] });
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            
            const [modalShift, setModalShift] = useState(null);

            // 安全的月份切換函式
            const handleMonthChange = (offset) => {
                setCurrentMonth(prev => {
                    const [year, month] = prev.split('-').map(Number);
                    const date = new Date(year, month - 1 + offset, 1);
                    const newYear = date.getFullYear();
                    const newMonth = String(date.getMonth() + 1).padStart(2, '0');
                    return `${newYear}-${newMonth}`;
                });
            };

            const [selectedDayIndex, setSelectedDayIndex] = useState(0);
            
            // Personal View State
            const [selectedPersonId, setSelectedPersonId] = useState("");

            // Touch Swipe State
            const [touchStart, setTouchStart] = useState(null);
            const [touchEnd, setTouchEnd] = useState(null);

            useEffect(() => {
                const savedId = localStorage.getItem('lastSelectedPersonId');
                if (savedId) {
                    setSelectedPersonId(savedId);
                }
            }, []);

            const handlePersonChange = (e) => {
                const newId = e.target.value;
                setSelectedPersonId(newId);
                localStorage.setItem('lastSelectedPersonId', newId);
            };

            // ==========================================
            // DATE STYLE LOGIC 日期樣式邏輯
            // ==========================================
            const getDateStyleInfo = (headerStr, currentMonth) => {
                if (!headerStr) return { type: 'normal', colorClass: 'text-gray-600' };

                const dayNum = headerStr.replace(/[^0-9]/g, '');
                const fullDate = `${currentMonth}-${dayNum.padStart(2, '0')}`;
                
                if (HOLIDAYS[fullDate]) {
                    return { 
                        type: 'holiday', 
                        label: HOLIDAYS[fullDate], 
                        colorClass: 'text-red-600 font-bold', 
                        bgClass: 'bg-red-50 border-red-200'
                    };
                }

                if (headerStr.includes('六')) {
                    return { 
                        type: 'weekend-sat', 
                        colorClass: 'text-green-600 font-bold', 
                        bgClass: 'bg-green-50 border-green-200' 
                    };
                }
                if (headerStr.includes('日')) {
                    return { 
                        type: 'weekend-sun', 
                        colorClass: 'text-red-500 font-bold', 
                        bgClass: 'bg-red-50 border-red-200' 
                    };
                }

                return { 
                    type: 'normal', 
                    colorClass: 'text-gray-600', 
                    bgClass: 'bg-white border-gray-200' 
                };
            };

            // ==========================================
            // SCROLL & SWIPE LOGIC
            // ==========================================
            const scrollRef = React.useRef(null);

            const scrollToDay = (index) => {
                setTimeout(() => {
                    const container = scrollRef.current;
                    const targetBtn = document.getElementById(`day-btn-${index}`);
                    
                    if (container && targetBtn) {
                        const scrollLeft = targetBtn.offsetLeft - (container.clientWidth / 2) + (targetBtn.clientWidth / 2);
                        container.scrollTo({ left: Math.max(0, scrollLeft), behavior: 'smooth' });
                    }
                }, 100); 
            };

            useEffect(() => {
                if (activeTab === 'daily') {
                    scrollToDay(selectedDayIndex);
                }
            }, [activeTab]);

            // Touch Handlers for Swipe
            const minSwipeDistance = 50; 

            const onTouchStart = (e) => {
                setTouchEnd(null); // Reset touch end to prevent jumpy behavior
                setTouchStart(e.targetTouches[0].clientX);
            };

            const onTouchMove = (e) => {
                setTouchEnd(e.targetTouches[0].clientX);
            };

            const onTouchEnd = () => {
                if (!touchStart || !touchEnd) return;
                const distance = touchStart - touchEnd;
                const isLeftSwipe = distance > minSwipeDistance;
                const isRightSwipe = distance < -minSwipeDistance;

                if (isLeftSwipe) {
                    // Swipe Left -> Next Day
                    if (selectedDayIndex < scheduleData.headers.length - 1) {
                        setSelectedDayIndex(prev => prev + 1);
                    }
                }
                if (isRightSwipe) {
                    // Swipe Right -> Prev Day
                    if (selectedDayIndex > 0) {
                        setSelectedDayIndex(prev => prev - 1);
                    }
                }
                // Reset (optional, but good practice)
                setTouchStart(null);
                setTouchEnd(null);
            };

            // ==========================================
            // FETCH DATA
            // ==========================================
            useEffect(() => {
                const fetchData = async () => {
                    setLoading(true);
                    setError(null);
                    setScheduleData({ headers: [], data: [] });

                    try {
                        if (!GOOGLE_SPREADSHEET_ID) throw new Error("請設定 GOOGLE_SPREADSHEET_ID");

                        const baseUrl = `https://docs.google.com/spreadsheets/d/${GOOGLE_SPREADSHEET_ID}/gviz/tq?tqx=out:csv`;
                        const defsUrl = `${baseUrl}&sheet=${encodeURIComponent(SHIFT_DEF_SHEET_NAME)}`;
                        const scheduleUrl = `${baseUrl}&sheet=${encodeURIComponent(currentMonth)}`;

                        const [resDefs, resSched] = await Promise.all([
                            fetch(defsUrl),
                            fetch(scheduleUrl)
                        ]);

                        if (!resDefs.ok) throw new Error("讀取班別資料失敗");
                        if (!resSched.ok) throw new Error(`讀取 ${currentMonth} 班表失敗`);

                        const defsText = await resDefs.text();
                        const scheduleText = await resSched.text();

                        if (scheduleText.includes("<!DOCTYPE html")) throw new Error("無法讀取資料，請檢查權限設定。");

                        const { defs, order } = processShiftDefs(defsText);
                        setShiftDefs(defs);
                        setShiftOrder(order);
                        
                        const processedSchedule = processSchedule(scheduleText);
                        if (processedSchedule.data.length === 0) throw new Error("無資料，請檢查 CSV 格式。");
                        setScheduleData(processedSchedule);

                    } catch (e) {
                        console.error(e);
                        setError(e.message);
                    } finally {
                        setLoading(false);
                    }
                };

                fetchData();
            }, [currentMonth]);

            // Auto-select logic
            useEffect(() => {
                if (scheduleData.headers.length === 0) return;

                const today = new Date();
                const currentYearMonth = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
                
                let targetIndex = 0;

                if (currentMonth === currentYearMonth) {
                    const todayDate = today.getDate(); 
                    const foundIndex = scheduleData.headers.findIndex(h => {
                        const hDay = parseInt(h.replace(/[^0-9]/g, ''));
                        return hDay === todayDate;
                    });

                    if (foundIndex !== -1) {
                        targetIndex = foundIndex;
                    }
                }

                setSelectedDayIndex(targetIndex);
                if (activeTab === 'daily') {
                    scrollToDay(targetIndex);
                }

            }, [scheduleData, currentMonth]);

            // ==========================================
            // COLOR LOGIC 顏色邏輯
            // ==========================================
            const getShiftStyle = (code) => {
                const c = (code || "").trim().toUpperCase();
                
                if (["O", "H", "N", "-", "D0"].includes(c)) return "bg-pink-50 text-pink-700 border-pink-200";
                if (["HA", "NN", "A"].includes(c) || c.includes("P")) return "bg-blue-50 text-blue-700 border-blue-200";
                if (c.includes("S") || c.includes("C")) return "bg-green-50 text-green-700 border-green-200";
                if (c.includes("D") || c.includes("U")) return "bg-yellow-50 text-yellow-700 border-yellow-200";
                return "bg-white border-gray-200 text-gray-700";
            };

            const getShiftInfo = (code) => {
                const cleanCode = (code || "").trim();
                return shiftDefs[cleanCode] || { time: "", desc: "" };
            };

            const handleShiftClick = (code) => {
                const info = getShiftInfo(code);
                setModalShift({ code, ...info });
            };

            const getTodayInfo = (personRow) => {
                if (!personRow || !scheduleData.headers) return null;
                const today = new Date();
                const todayYearMonth = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
                if (currentMonth !== todayYearMonth) return { isToday: false, msg: "非當月資料" };
                const dayOfMonth = today.getDate(); 
                const headerIndex = scheduleData.headers.findIndex(h => {
                    const hDay = parseInt(h.replace(/[^0-9]/g, ''));
                    return hDay === dayOfMonth;
                });
                if (headerIndex === -1) return { isToday: false, msg: "無今日資料" };
                const shiftCode = personRow[3 + headerIndex];
                const shiftInfo = getShiftInfo(shiftCode);
                return { isToday: true, dateStr: `${today.getMonth() + 1}/${dayOfMonth}`, shiftCode, shiftInfo };
            };

            return (
                <div className="min-h-screen pb-20 max-w-4xl mx-auto bg-white shadow-lg min-h-screen flex flex-col">
                    <header className="bg-blue-600 text-white p-4 sticky top-0 z-40 shadow-md">
                        <div className="flex justify-between items-center mb-4">
                            <h1 className="text-xl font-bold flex items-center gap-2">
                                <i data-lucide="calendar"></i>
                                線上排班系統
                            </h1>
                            
                            <div className="flex items-center bg-blue-800/50 rounded-lg p-0.5 border border-blue-500/30">
                                <button 
                                    onClick={() => handleMonthChange(-1)}
                                    className="p-1.5 hover:bg-blue-700 rounded-md text-blue-100 hover:text-white transition-colors"
                                >
                                    <i data-lucide="chevron-left" className="w-5 h-5"></i>
                                </button>
                                <span className="mx-2 font-bold text-white tracking-wider min-w-[80px] text-center">
                                    {currentMonth}
                                </span>
                                <button 
                                    onClick={() => handleMonthChange(1)}
                                    className="p-1.5 hover:bg-blue-700 rounded-md text-blue-100 hover:text-white transition-colors"
                                >
                                    <i data-lucide="chevron-right" className="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>
                        <div className="flex bg-blue-800 p-1 rounded-lg">
                            <button onClick={() => setActiveTab('daily')} className={`flex-1 py-2 text-sm font-medium rounded-md transition-all ${activeTab === 'daily' ? 'bg-white text-blue-800 shadow' : 'text-blue-200 hover:text-white'}`}>每日人員</button>
                            <button onClick={() => setActiveTab('personal')} className={`flex-1 py-2 text-sm font-medium rounded-md transition-all ${activeTab === 'personal' ? 'bg-white text-blue-800 shadow' : 'text-blue-200 hover:text-white'}`}>個人班表</button>
                        </div>
                    </header>

                    <main className="p-4 flex-grow">
                        {error ? (
                            <div className="bg-red-50 text-red-600 p-6 rounded-lg border border-red-200 text-center">
                                <i data-lucide="alert-circle" className="mx-auto mb-2 w-8 h-8 text-red-500"></i>
                                <h3 className="font-bold mb-2">無法讀取資料</h3>
                                <p className="text-sm">{error}</p>
                            </div>
                        ) : (
                            (loading && !scheduleData.data.length) ? (
                                <div className="flex items-center justify-center h-64 flex-col">
                                    <div className="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600 mb-4"></div>
                                    <p className="text-gray-500">正在讀取 {currentMonth} 班表...</p>
                                </div>
                            ) : (
                                <>
                                    {/* VIEW: DAILY (每日檢視) */}
                                    {activeTab === 'daily' && scheduleData.headers.length > 0 && (
                                        <div className="animate-fade-in">
                                            {/* Date Slider */}
                                            <div 
                                                ref={scrollRef}
                                                className="flex overflow-x-auto pb-4 gap-2 hide-scrollbar mb-4 -mx-4 px-4 bg-gray-50 pt-2 border-b"
                                            >
                                                {scheduleData.headers.map((dayLabel, idx) => {
                                                    const dateStyle = getDateStyleInfo(dayLabel, currentMonth);
                                                    const isSelected = selectedDayIndex === idx;

                                                    return (
                                                        <button
                                                            key={idx}
                                                            id={`day-btn-${idx}`}
                                                            onClick={() => setSelectedDayIndex(idx)}
                                                            className={`flex-shrink-0 w-14 h-16 flex flex-col items-center justify-center rounded-lg border transition-all relative overflow-hidden ${
                                                                isSelected 
                                                                ? 'bg-blue-600 text-white border-blue-600 shadow-md transform scale-105 z-10' 
                                                                : `${dateStyle.bgClass} ${dateStyle.colorClass} hover:border-blue-300`
                                                            }`}
                                                        >
                                                            {dateStyle.type === 'holiday' && !isSelected && (
                                                                <span className="absolute top-1 right-1 w-1.5 h-1.5 bg-red-500 rounded-full"></span>
                                                            )}
                                                            <span className={`text-xs ${isSelected ? 'opacity-80' : 'opacity-70'}`}>
                                                                {dayLabel.replace(/[0-9]/g, '')}
                                                            </span>
                                                            <span className="text-lg font-bold">
                                                                {dayLabel.replace(/[^0-9]/g, '')}
                                                            </span>
                                                        </button>
                                                    );
                                                })}
                                            </div>

                                            <div className="flex justify-between items-end mb-4">
                                                <h2 className="text-lg font-bold text-gray-800 flex items-center">
                                                    <span className="bg-blue-100 text-blue-800 px-2 py-1 rounded mr-2 text-sm">
                                                        {scheduleData.headers[selectedDayIndex]}
                                                    </span>
                                                    {(() => {
                                                        const info = getDateStyleInfo(scheduleData.headers[selectedDayIndex], currentMonth);
                                                        if(info.type === 'holiday') return <span className="mr-2 text-red-600 bg-red-100 px-2 py-0.5 rounded text-xs">{info.label}</span>;
                                                        return null;
                                                    })()}
                                                    當日排班
                                                </h2>
                                                {/* 手機版滑動提示 */}
                                                <div className="text-[10px] text-gray-400 md:hidden flex items-center">
                                                    <i data-lucide="move-horizontal" className="w-3 h-3 mr-1"></i>
                                                    左右滑動換頁
                                                </div>
                                            </div>

                                            {/* Daily Content Area with Touch Listeners */}
                                            <div 
                                                className="flex flex-col gap-2 min-h-[300px]"
                                                onTouchStart={onTouchStart}
                                                onTouchMove={onTouchMove}
                                                onTouchEnd={onTouchEnd}
                                            >
                                                {(() => {
                                                    const dayShifts = {};
                                                    scheduleData.data.forEach(person => {
                                                        const shift = person[3 + selectedDayIndex]; 
                                                        if(!shift || shift === "-" || shift === "") return;
                                                        if(!dayShifts[shift]) dayShifts[shift] = [];
                                                        dayShifts[shift].push(person[2]);
                                                    });

                                                    const sortedShifts = Object.keys(dayShifts).sort((a, b) => {
                                                        const idxA = shiftOrder.indexOf(a);
                                                        const idxB = shiftOrder.indexOf(b);
                                                        if(idxA === -1 && idxB === -1) return 0;
                                                        if(idxA === -1) return 1;
                                                        if(idxB === -1) return -1;
                                                        return idxA - idxB;
                                                    });

                                                    if (sortedShifts.length === 0) return <div className="text-gray-400 text-center py-16 bg-gray-50 rounded-lg border border-dashed border-gray-200">本日無排班資料</div>;

                                                    return sortedShifts.map(shiftCode => {
                                                        const isOff = ["O", "H", "U", "OFF", "-"].includes(shiftCode);
                                                        return (
                                                            <div 
                                                                key={shiftCode} 
                                                                onClick={() => handleShiftClick(shiftCode)}
                                                                className={`flex items-stretch rounded-lg border transition-colors cursor-pointer hover:shadow-md active:scale-[0.99] select-none ${getShiftStyle(shiftCode)} ${isOff ? 'opacity-80' : ''}`}
                                                            >
                                                                <div className="w-20 flex-shrink-0 flex items-center justify-center border-r border-black/5 bg-black/5 font-bold text-xl p-2">
                                                                    {shiftCode}
                                                                </div>
                                                                <div className="flex-grow p-3 flex flex-wrap gap-2 items-center bg-white/30">
                                                                    {dayShifts[shiftCode].map(name => (
                                                                        <span key={name} className="bg-white border border-black/10 px-4 py-2 rounded-full text-xl font-bold text-gray-800 shadow-sm">
                                                                            {name}
                                                                        </span>
                                                                    ))}
                                                                </div>
                                                            </div>
                                                        );
                                                    });
                                                })()}
                                            </div>
                                        </div>
                                    )}

                                    {/* VIEW: PERSONAL (個人檢視) */}
                                    {activeTab === 'personal' && (
                                        <div className="animate-fade-in">
                                            
                                            <div className="mb-6 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                                                <label className="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">
                                                    選擇人員 (系統將自動記憶)
                                                </label>
                                                <div className="relative">
                                                    <select
                                                        value={selectedPersonId}
                                                        onChange={handlePersonChange}
                                                        className="w-full appearance-none bg-gray-50 border border-gray-300 text-gray-900 text-lg rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-3 pr-10"
                                                    >
                                                        <option value="" disabled>請選擇人員...</option>
                                                        {scheduleData.data.map(p => (
                                                            <option key={p[1]} value={p[1]}>
                                                                {p[2]}
                                                            </option>
                                                        ))}
                                                    </select>
                                                    <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-500">
                                                        <i data-lucide="chevron-down" className="w-5 h-5"></i>
                                                    </div>
                                                </div>
                                            </div>

                                            {selectedPersonId ? (() => {
                                                const person = scheduleData.data.find(p => p[1] === selectedPersonId);
                                                if (!person) return <div className="text-center text-gray-500">查無此人資料</div>;

                                                let workDays = 0, offDays = 0;
                                                person.slice(3).forEach(s => {
                                                    if(["O", "H", "U", "OFF", "-"].includes(s)) offDays++;
                                                    else if(s && s !== "") workDays++;
                                                });

                                                const todayData = getTodayInfo(person);
                                                let startCol = 1;
                                                if (scheduleData.headers.length > 0) {
                                                    const firstDayStr = scheduleData.headers[0];
                                                    if (firstDayStr.includes('日')) startCol = 1;
                                                    else if (firstDayStr.includes('一')) startCol = 2;
                                                    else if (firstDayStr.includes('二')) startCol = 3;
                                                    else if (firstDayStr.includes('三')) startCol = 4;
                                                    else if (firstDayStr.includes('四')) startCol = 5;
                                                    else if (firstDayStr.includes('五')) startCol = 6;
                                                    else if (firstDayStr.includes('六')) startCol = 7;
                                                }

                                                return (
                                                    <div className="space-y-6">
                                                        
                                                        {todayData && todayData.isToday ? (
                                                            <div 
                                                                className={`rounded-xl border-l-8 shadow-lg overflow-hidden transform transition hover:scale-[1.02] cursor-pointer ${getShiftStyle(todayData.shiftCode)}`}
                                                                onClick={() => handleShiftClick(todayData.shiftCode)}
                                                            >
                                                                <div className="p-5 flex justify-between items-center bg-white/40 backdrop-blur-sm">
                                                                    <div>
                                                                        <div className="text-sm font-bold opacity-70 mb-1">
                                                                            今日班表 ({todayData.dateStr})
                                                                        </div>
                                                                        <div className="text-4xl font-black tracking-tight">
                                                                            {todayData.shiftCode}
                                                                        </div>
                                                                    </div>
                                                                    <div className="text-right">
                                                                        <div className="text-lg font-bold">
                                                                            {todayData.shiftInfo.time || "無時間"}
                                                                        </div>
                                                                        <div className="text-xs opacity-70 max-w-[150px] truncate">
                                                                            {todayData.shiftInfo.desc}
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        ) : (
                                                            <div className="bg-gray-100 rounded-xl p-4 text-center text-gray-400 text-sm border border-dashed border-gray-300">
                                                                {todayData ? todayData.msg : "無法顯示今日資訊"}
                                                            </div>
                                                        )}

                                                        <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-4 flex justify-between items-center">
                                                            <div>
                                                                <h2 className="text-2xl font-black text-gray-800">{person[2]}</h2>
                                                            </div>
                                                            <div className="flex gap-4 text-sm">
                                                                <div className="text-center">
                                                                    <div className="font-bold text-gray-800">{workDays}</div>
                                                                    <div className="text-xs text-gray-500">出勤</div>
                                                                </div>
                                                                <div className="text-center">
                                                                    <div className="font-bold text-gray-800">{offDays}</div>
                                                                    <div className="text-xs text-gray-500">休假</div>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                                                            <div className="grid grid-cols-7 bg-gray-50 border-b border-gray-200 text-center py-2 text-xs font-bold text-gray-500">
                                                                <div className="text-red-400">日</div>
                                                                <div>一</div>
                                                                <div>二</div>
                                                                <div>三</div>
                                                                <div>四</div>
                                                                <div>五</div>
                                                                <div className="text-green-600">六</div>
                                                            </div>
                                                            <div className="grid grid-cols-7 gap-px bg-gray-200">
                                                                {scheduleData.headers.map((date, idx) => {
                                                                    const shiftCode = person[3 + idx];
                                                                    const dayNum = date.replace(/[^0-9]/g, '');
                                                                    const style = getShiftStyle(shiftCode);
                                                                    const dateStyle = getDateStyleInfo(date, currentMonth);
                                                                    const gridClass = idx === 0 ? `col-start-${startCol}` : '';

                                                                    return (
                                                                        <div 
                                                                            key={idx} 
                                                                            className={`bg-white min-h-[80px] p-1 flex flex-col justify-between hover:bg-blue-50 cursor-pointer transition group ${gridClass}`}
                                                                            onClick={() => {
                                                                                setSelectedDayIndex(idx);
                                                                                setActiveTab('daily');
                                                                            }}
                                                                        >
                                                                            <div className="flex justify-between items-start">
                                                                                {/* 套用日期顏色樣式 */}
                                                                                <div className={`text-xs font-medium pl-1 group-hover:text-blue-600 ${dateStyle.colorClass}`}>
                                                                                    {dayNum}
                                                                                </div>
                                                                                
                                                                                {dateStyle.type === 'holiday' && (
                                                                                    <span className="text-[10px] bg-red-100 text-red-600 px-1 rounded transform scale-90 origin-right">
                                                                                        {dateStyle.label}
                                                                                    </span>
                                                                                )}

                                                                                {dateStyle.type !== 'holiday' && (
                                                                                    <i data-lucide="arrow-up-right" className="w-3 h-3 text-blue-300 opacity-0 group-hover:opacity-100 transition-opacity mr-1"></i>
                                                                                )}
                                                                            </div>
                                                                            
                                                                            {shiftCode && shiftCode !== "-" ? (
                                                                                <div className={`text-center py-1 rounded mx-1 font-bold text-sm shadow-sm border ${style.replace('border-l-4', '')}`}>
                                                                                    {shiftCode}
                                                                                </div>
                                                                            ) : (
                                                                                <div className="h-6"></div>
                                                                            )}
                                                                            
                                                                            <div className="h-2"></div>
                                                                        </div>
                                                                    );
                                                                })}
                                                            </div>
                                                        </div>

                                                    </div>
                                                );
                                            })() : (
                                                <div className="text-center py-16 bg-white rounded-xl shadow-sm border border-gray-100">
                                                    <div className="bg-blue-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-500">
                                                        <i data-lucide="user" className="w-8 h-8"></i>
                                                    </div>
                                                    <h3 className="text-lg font-bold text-gray-800 mb-2">請選擇人員</h3>
                                                    <p className="text-gray-500 text-sm">選擇後系統將自動記住您的身份</p>
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </>
                            )
                        )}
                    </main>

                    <ShiftDetailModal shiftInfo={modalShift} onClose={() => setModalShift(null)} />

                    <footer className="bg-white border-t border-gray-200 p-4 text-center text-xs text-gray-400 mt-auto">
                        © 2026 線上排班系統 | 資料來源: Google Sheets
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
        
        setTimeout(() => {
            if(window.lucide) window.lucide.createIcons();
        }, 500);
    </script>
</body>
</html>
